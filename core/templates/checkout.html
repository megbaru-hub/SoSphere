{% extends 'base.html' %}
{% load static %}
{% load math_filters %}
{% load humanize %}

{% block title %}Secure Checkout - Grand Seller{% endblock %}

{% block content %}
<style>
    /* ========================================================
    BEST PRACTICE CSS STYLING
    ========================================================
    */
    :root {
        --grand-seller-gold: #FFD700;        /* Primary Gold */
        --grand-seller-dark-gold: #DAA520;   /* Darker Gold for accents */
        --grand-seller-bg-dark: #222831;     /* Dark background */
        --grand-seller-shadow-gold: rgba(255, 215, 0, 0.3); /* Golden shadow */
        --error-red: #dc3545;
        --success-green: #28a745;
    }

    /* Step Transitions */
    .step { 
        transition: opacity 0.4s ease-in-out, transform 0.4s ease; 
        opacity: 1; 
        transform: translateX(0);
        min-height: 400px; /* Ensure consistent height during transition */
    }
    .step.hidden { 
        opacity: 0; 
        position: absolute; 
        left: 0;
        right: 0;
        z-index: -1;
        pointer-events: none;
    }
    
    /* Typography */
    h1, h3 { 
        color: var(--grand-seller-bg-dark); 
        font-weight: 700; 
        letter-spacing: 0.5px; 
    }
    .lead { 
        color: var(--grand-seller-dark-gold); 
        font-weight: 600; 
    }
    .form-section { 
        border-radius: 12px; 
        padding: 25px; 
        border: 1px solid #eee; 
        background-color: #fff; 
        box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        position: relative; 
    }

    /* Progress Bar */
    .progress { 
        height: 10px;
        border-radius: 5px; 
        background-color: #e9ecef; 
    }
    .progress-bar { 
        background: linear-gradient(90deg, var(--grand-seller-dark-gold), var(--grand-seller-gold)) !important; 
        transition: width 0.4s cubic-bezier(0.2, 0.8, 0.5, 1);
        box-shadow: 0 0 8px var(--grand-seller-shadow-gold);
    }

    /* Form Elements & Focus */
    .form-control, .form-select, .stripe-element {
        border-radius: 8px !important;
        padding: 12px 15px !important;
        font-size: 1rem;
        transition: border-color 0.3s, box-shadow 0.3s, transform 0.3s;
    }
    .form-control:focus, .form-select:focus, .StripeElement--focus {
        border-color: var(--grand-seller-dark-gold) !important;
        box-shadow: 0 0 0 0.2rem var(--grand-seller-shadow-gold) !important;
        transform: translateY(-1px);
    }
    .input-group-text {
        background-color: var(--grand-seller-bg-dark); 
        color: var(--grand-seller-gold); 
        border-right: none;
        border-radius: 8px 0 0 8px !important;
        font-weight: 500;
        padding: 0 15px;
    }
    .input-group .form-control {
        border-left: none;
        border-radius: 0 8px 8px 0 !important;
    }
    .stripe-element {
        border: 1px solid #ced4da; /* Consistent border for Stripe fields */
        background-color: #fff;
    }
    
    /* Buttons */
    .btn {
        text-transform: uppercase;
        letter-spacing: 1px;
    }
    .btn-checkout-primary { 
        background: linear-gradient(135deg, var(--grand-seller-dark-gold), var(--grand-seller-gold)); 
        border-color: var(--grand-seller-dark-gold);
        color: #fff;
        font-weight: 700;
        border-radius: 50px;
        padding: 12px 30px;
        transition: all 0.3s;
        box-shadow: 0 6px 20px rgba(218, 165, 32, 0.4);
    }
    .btn-checkout-primary:hover:not(:disabled) {
        transform: translateY(-3px);
        box-shadow: 0 8px 25px rgba(255, 215, 0, 0.5); 
    }
    .btn-checkout-success {
        background-color: var(--grand-seller-bg-dark); 
        border-color: var(--grand-seller-bg-dark);
        color: var(--grand-seller-gold);
        font-weight: 700;
        border-radius: 50px;
        padding: 12px 30px;
        transition: all 0.3s;
        box-shadow: 0 6px 20px rgba(34, 40, 49, 0.4);
    }
    .btn-checkout-success:hover:not(:disabled) {
        background-color: #333d4a;
        border-color: #333d4a;
        transform: translateY(-3px);
        box-shadow: 0 8px 25px rgba(34, 40, 49, 0.5);
    }
    .btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }

    /* Errors */
    .is-invalid { 
        border-color: var(--error-red) !important; 
        box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25) !important;
    }
    .invalid-feedback { 
        color: var(--error-red); 
        font-size: 0.9rem;
        font-weight: 600; 
        margin-top: 0.5rem;
        display: block;
    }
    .error-bar {
        background: #f8d7da;
        border: 1px solid #f5c6cb;
        border-radius: 8px;
        color: #721c24;
        padding: 1rem;
        margin-top: 1rem;
        display: none;
        font-weight: 600;
        box-shadow: 0 2px 5px rgba(220, 53, 69, 0.15);
    }
    .error-bar.show {
        display: block;
    }
</style>

<div class="container my-5">
    <h1 class="my-4">Secure Checkout</h1>
    <p class="lead mb-4">Order Total: <small>ETB</small> <span id="orderTotalDisplay">{{ total|floatformat:2|intcomma }}</span></p>

    <div class="progress mb-5">
        <div class="progress-bar" role="progressbar" id="checkout-progress-bar" style="width: 50%;"></div>
    </div>

    <form method="post" id="checkoutForm">
        {% csrf_token %}
        
        <div id="step1" class="step form-section">
            <h3>1. Customer & Delivery Information</h3>
            <div class="row">
                <div class="col-md-6">
                    <div class="mb-4">
                        <label class="form-label">Full Name <span class="text-danger">*</span></label>
                        <div class="input-group">
                            <span class="input-group-text"><i class="bi bi-person"></i></span>
                            <input type="text" class="form-control" name="name" placeholder="Your Name" required autofocus>
                        </div>
                        <div class="invalid-feedback" id="nameError"></div>
                    </div>
                    <div class="mb-4">
                        <label class="form-label">Email <span class="text-danger">*</span></label>
                        <div class="input-group">
                            <span class="input-group-text"><i class="bi bi-envelope"></i></span>
                            <input type="email" class="form-control" name="email" placeholder="Email" required>
                        </div>
                        <div class="invalid-feedback" id="emailError"></div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="mb-4">
                        <label class="form-label">Phone Number <span class="text-danger">*</span></label>
                        <div class="input-group">
                            <span class="input-group-text">+251</span> 
                            <input type="tel" class="form-control" name="phone" placeholder="9XXXXXXXX or 7XXXXXXXX" required maxlength="9" pattern="[97][0-9]{8}">
                        </div>
                        <div class="invalid-feedback" id="phoneError"></div>
                    </div>
                    <div class="mb-4">
                        <label class="form-label">City <span class="text-danger">*</span></label>
                        <select class="form-select" id="citySelect" name="city" required>
                            <option value="">Select City</option>
                            <option value="addis-ababa">Addis Ababa</option>
                            <option value="adama">Adama</option>
                            <option value="gondar">Gondar</option>
                            <option value="bahir-dar">Bahir Dar</option>
                            <option value="hawassa">Hawassa</option>
                            <option value="mekelle">Mekelle</option>
                            <option value="dire-dawa">Dire Dawa</option>
                            <option value="jimma">Jimma</option>
                            <option value="other">Other (specify below)</option>
                        </select>
                        <div class="invalid-feedback" id="cityError"></div>
                    </div>
                    <div class="mb-4" id="otherCityField" style="display:none;">
                        <label class="form-label">Other City <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" name="other_city" placeholder="Specify your city">
                        <div class="invalid-feedback" id="otherCityError"></div>
                    </div>
                </div>
            </div>
            
            <button type="button" id="nextBtn" class="btn btn-checkout-primary float-end">
                Next Step <i class="bi bi-arrow-right-circle-fill"></i>
            </button>
            <div id="step1Error" class="error-bar"></div>
        </div>

        <div id="step2" class="step form-section hidden">
            <h3>2. Payment Method</h3>
            <div class="mb-4">
                <label class="form-label">Choose Method <span class="text-danger">*</span></label>
                <select class="form-select" name="payment_method" id="methodSelect" required>
                    <option value="">Select...</option>
                    <option value="TEST_SUCCESS">TEST PAYMENT (Bypass Gateway)</option>
                    <option value="telebirr">TeleBirr (Chapa)</option>
                    <option value="cbe">CBE Birr/Bank (Chapa)</option>
                    <option value="abyssinia">Abyssinia Bank (Chapa)</option>
                    <option value="mpesa">M-Pesa (Chapa)</option>
                    <option value="card">International Card (Stripe)</option>
                </select>
                <div class="invalid-feedback" id="methodError"></div>
            </div>

            <div id="localPaymentFields" class="alert alert-info" style="display:none;">
                <i class="bi bi-info-circle"></i> <small>You will be securely redirected to the external payment gateway to complete the transaction.</small>
            </div>

            <div id="cardSection" style="display:none;">
                <h5 class="mb-3">Card Details (Stripe Secured)</h5>
                <div class="mb-3">
                    <label class="form-label">Card Number</label>
                    <div id="card-element" class="stripe-element"></div>
                </div>
                <div class="row">
                    <div class="col-6 mb-3">
                        <label class="form-label">Expiry (MM/YY)</label>
                        <div id="card-expiry" class="stripe-element"></div>
                    </div>
                    <div class="col-6 mb-3">
                        <label class="form-label">CVC</label>
                        <div id="card-cvc" class="stripe-element"></div>
                    </div>
                </div>
            </div>

            <div id="errorMessage" class="error-bar"></div>

            <div class="d-flex justify-content-between mt-5">
                <button type="button" id="backBtn" class="btn btn-secondary">
                    <i class="bi bi-arrow-left"></i> Back
                </button>
                <button type="submit" class="btn btn-checkout-success" id="payButton" disabled>
                    Pay <small>ETB</small> <span id="payButtonTotal">{{ total|floatformat:2|intcomma }}</span> <i class="bi bi-lock-fill"></i>
                </button>
            </div>
        </div>
    </form>
</div>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
<script src="https://js.stripe.com/v3/"></script>
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

<script>
// CRITICAL CSRF FIX: Function to securely get CSRF token from cookie
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            let cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
const csrftoken = getCookie('csrftoken');


// --- Initialization ---
// NOTE: Replace 'pk_test_dummy' with your actual Django setting 
const stripe = Stripe('{{ STRIPE_PUBLISHABLE_KEY|default:"pk_test_dummy" }}');
const elements = stripe.elements();
const totalAmount = $('#orderTotalDisplay').text(); // Get amount for display on the button

const cardStyle = { 
    base: { 
        fontSize: '16px', 
        color: '#32325d', 
        '::placeholder': { color: '#aab7c4' } 
    } 
};

// Create and mount Stripe elements only once
const card = elements.create('cardNumber', {style: cardStyle});
card.mount('#card-element');
const expiry = elements.create('cardExpiry', {style: cardStyle});
expiry.mount('#card-expiry');
const cvc = elements.create('cardCvc', {style: cardStyle});
cvc.mount('#card-cvc');

let currentStep = 1;
const CHAPA_METHODS = ['cbe', 'abyssinia', 'telebirr', 'mpesa'];

// --- Step 1 Field Logic (City Dropdown) ---
$('#citySelect').on('change', function() {
    const isOther = $(this).val() === 'other';
    $('#otherCityField').toggle(isOther);
    // Use .prop() for required attribute consistency
    $('input[name="other_city"]').prop('required', isOther); 
    if (!isOther) {
        $('input[name="other_city"]').val(''); // Clear value if not 'other'
        $('input[name="other_city"]').removeClass('is-invalid'); // Clear validation
    }
});

// --- Validation and Error Helpers ---
function clearValidation() {
    $('.form-control, .form-select').removeClass('is-invalid');
    $('.invalid-feedback').text('').hide();
    $('.error-bar').hide().removeClass('show').text('');
}

function validateStep1() {
    let isValid = true;
    clearValidation(); // Clear all previous errors first

    // Check all required fields
    $('#step1 :required').each(function() {
        const input = $(this);
        const name = input.attr('name');
        const value = input.val().trim();
        const errorElement = $(`#${name}Error`);

        if (!value) {
            input.addClass('is-invalid');
            errorElement.text(`${input.closest('div').find('label').text().replace(' *', '').trim()} is required.`).show();
            isValid = false;
        } else {
            // Specific validation
            if (name === 'email' && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(value)) {
                input.addClass('is-invalid');
                errorElement.text('Enter a valid email address.').show();
                isValid = false;
            }
            if (name === 'phone' && !/^(9|7)[0-9]{8}$/.test(value)) {
                input.addClass('is-invalid');
                errorElement.text('Phone must be 9 digits (starting with 9 or 7).').show();
                isValid = false;
            }
            if (name === 'other_city' && $('#citySelect').val() === 'other' && !value) {
                input.addClass('is-invalid');
                errorElement.text('Please specify the city name.').show();
                isValid = false;
            }
        }
    });

    if (!isValid) {
        $('#step1Error').text('Please correct the highlighted errors before proceeding.').addClass('show');
    }

    return isValid;
}

// --- Step Transition Handlers ---
$('#nextBtn').click(function() {
    if (validateStep1()) {
        $('#step1').addClass('hidden');
        $('#step2').removeClass('hidden');
        currentStep = 2;
        $('#checkout-progress-bar').css('width', '100%');
    }
});

$('#backBtn').click(function() {
    $('#step2').addClass('hidden');
    $('#step1').removeClass('hidden');
    currentStep = 1;
    $('#checkout-progress-bar').css('width', '50%');
    clearValidation(); // Clear errors when moving back
});

// --- Step 2 Payment Method Change Handler ---
$('#methodSelect').on('change', function() {
    const method = $(this).val();
    clearValidation(); // Clear any previous errors

    // Hide all extra fields
    $('#localPaymentFields, #cardSection').hide();
    
    // Disable button if no method selected
    $('#payButton').prop('disabled', !method); 

    // Update UI based on selection
    let buttonText = `Pay ETB ${totalAmount.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',')} <i class="bi bi-lock-fill"></i>`;
    let buttonIcon = '<i class="bi bi-lock-fill"></i>';

    if (method === 'card') {
        $('#cardSection').fadeIn();
    } else if (CHAPA_METHODS.includes(method) || method === 'TEST_SUCCESS') {
        $('#localPaymentFields').fadeIn();
        buttonText = `Proceed to ${method === 'TEST_SUCCESS' ? 'Test' : method.toUpperCase()}`;
        buttonIcon = '<i class="bi bi-arrow-up-right-square"></i>';
    }

    $('#payButton').html(`${buttonText} ${buttonIcon}`);
});

// --- Function to reset the pay button state ---
function resetPayButton(method) {
    const buttonElement = $('#payButton');
    
    let buttonText = `Pay ETB ${totalAmount.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',')}`;
    let buttonIcon = '<i class="bi bi-lock-fill"></i>';
    
    if (method && (CHAPA_METHODS.includes(method) || method === 'TEST_SUCCESS')) {
        buttonText = `Proceed to ${method === 'TEST_SUCCESS' ? 'Test' : method.toUpperCase()}`;
        buttonIcon = '<i class="bi bi-arrow-up-right-square"></i>';
    }
    
    buttonElement.prop('disabled', false).html(`${buttonText} ${buttonIcon}`);
}

// --- Form Submission Handler ---
$('#checkoutForm').submit(function(e) {
    e.preventDefault();
    if (currentStep !== 2) return;
    
    const method = $('#methodSelect').val();
    if (!method) {
        $('#methodSelect').addClass('is-invalid');
        $('#methodError').text('Please select a payment method.').show();
        return;
    }

    clearValidation();
    $('#payButton').prop('disabled', true).html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Processing...');

    // Helper to extract common data
    const getCommonFormData = () => {
        const formData = new FormData();
        formData.append('csrfmiddlewaretoken', csrftoken); 
        
        formData.append('name', $('input[name="name"]').val());
        formData.append('email', $('input[name="email"]').val());
        formData.append('phone', $('input[name="phone"]').val());
        formData.append('city', $('#citySelect').val() === 'other' ? $('input[name="other_city"]').val() : $('#citySelect').val());
        formData.append('payment_method', method);
        // CRITICAL: Send for display/logging, but backend must calculate charge amount!
        formData.append('client_total', totalAmount); 
        return formData;
    };

    if (method === 'card') {
        // Stripe Path
        stripe.createToken(card).then(function(result) {
            if (result.error) {
                $('#errorMessage').text(result.error.message).addClass('show');
                resetPayButton(method);
            } else {
                const formData = getCommonFormData();
                formData.append('stripeToken', result.token.id); 
                submitPayment(formData, method);
            }
        });
    } else {
        // Chapa or Test Payment Path
        const formData = getCommonFormData();
        submitPayment(formData, method);
    }
});

// AJAX submission for all payment types
function submitPayment(formData, method) {
    $.ajax({
        type: 'POST',
        // IMPORTANT: Ensure this Django URL is defined in your urls.py
        url: "{% url 'process_payment' %}", 
        data: formData,
        processData: false,
        contentType: false,
        success: function(data) {
            if (data.success && data.redirect_url) {
                // Redirect for Chapa (or final success page)
                window.location.href = data.redirect_url; 
            } else {
                // Payment initialization/attempt failed or unexpected response
                $('#errorMessage').text(data.message || 'Payment processing failed. Please try again.').addClass('show');
                resetPayButton(method);
            }
        },
        error: function(xhr) {
            let errorMsg = 'Network error or server issue. Please try again.';
            if (xhr.status === 403) {
                 errorMsg = 'Security Error (403 Forbidden). Please refresh the page and try again.';
            } else if (xhr.responseJSON && xhr.responseJSON.message) {
                 errorMsg = xhr.responseJSON.message;
            }
            $('#errorMessage').text(errorMsg).addClass('show');
            resetPayButton(method);
        }
    });
}
</script>
{% endblock %}