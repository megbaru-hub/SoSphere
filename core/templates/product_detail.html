{% extends 'base.html' %}
{% block title %}{{ product.name }} - Grand Seller{% endblock %}
{% block extra_head %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
{% endblock %}
{% block content %}

<style>
    :root {
        --grand-seller-gold: #FFD700;
        --grand-seller-dark-gold: #DAA520;
        --grand-seller-bg-dark: #222831;
    }
    .golden-text-heading {
        color: var(--grand-seller-dark-gold) !important;
        text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.1);
    }
    .dark-golden-text {
        color: var(--grand-seller-dark-gold) !important;
    }
    .btn-golden-success {
        background-color: var(--grand-seller-dark-gold);
        color: #ffffff; 
        border: 1px solid var(--grand-seller-dark-gold);
        font-weight: 600;
        border-radius: 50px;
        transition: all 0.3s ease;
    }
    .btn-golden-success:hover {
        background-color: var(--grand-seller-gold);
        color: var(--grand-seller-bg-dark);
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        transform: translateY(-1px);
    }
    /* Variant Thumbnails Container */
    .variant-thumbnails {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-top: 15px;
        padding: 5px;
        overflow-x: auto;
        scrollbar-width: thin;
    }
    
    /* Hide scrollbar for Chrome, Safari and Opera */
    .variant-thumbnails::-webkit-scrollbar {
        height: 6px;
    }
    
    .variant-thumbnails::-webkit-scrollbar-thumb {
        background-color: var(--grand-seller-gold);
        border-radius: 3px;
    }
    
    .img-thumbnail-variant {
        width: 70px;
        height: 70px;
        object-fit: cover;
        border: 2px solid #e9ecef;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
        background-color: #fff;
        position: relative;
        flex-shrink: 0;
    }
    .img-thumbnail-variant:hover {
        border-color: var(--grand-seller-gold);
        transform: translateY(-3px);
        box-shadow: 0 6px 12px rgba(0,0,0,0.1);
        z-index: 2;
    }
    
    .img-thumbnail-variant.active {
        border: 3px solid var(--grand-seller-dark-gold) !important;
        box-shadow: 0 0 0 2px rgba(218, 165, 32, 0.3), 0 4px 8px rgba(0,0,0,0.15);
        transform: translateY(-3px) scale(1.05);
        z-index: 3;
        position: relative;
    }
    
    /* Add a checkmark overlay for active variant */
    .img-thumbnail-variant.active::after {
        content: 'âœ“';
        position: absolute;
        top: -8px;
        right: -8px;
        width: 22px;
        height: 22px;
        background: var(--grand-seller-dark-gold);
        color: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        font-weight: bold;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    .form-select {
        border-radius: 10px;
    }
    .form-control {
        border-radius: 50px 0 0 50px !important;
    }
    .input-group-text {
        border-radius: 50px 0 0 50px;
    }
    .input-group .btn {
        border-radius: 0 50px 50px 0 !important;
    }
</style>

<div class="row">
    <div class="col-md-6">
        <img id="productImage" src="{{ product.image.url|default:'https://via.placeholder.com/600x450?text=No+Image' }}" class="img-fluid rounded shadow" alt="{{ product.name }}" style="max-height: 450px; width: 100%; object-fit: cover;">
        
        {% if variants|length > 0 %}
        <div class="variant-thumbnails">
            {% if product.image.url %}
            <img src="{{ product.image.url }}" 
                 class="img-thumbnail img-thumbnail-variant active" 
                 alt="Main Image" 
                 data-id="{{ product.pk }}"
                 data-price="{{ product.price }}"
                 data-image="{{ product.image.url }}"
                 data-stock="{{ product.stock }}"
                 style="width: 75px; height: 75px;">
            {% endif %}
            
            {% for variant in variants %}
            <img src="{{ variant.image.url|default:product.image.url }}" 
                 class="img-thumbnail img-thumbnail-variant {% if forloop.first %}active{% endif %}" 
                 alt="{{ variant.color.name }}" 
                 data-id="{{ variant.id }}"
                 data-price="{{ variant.price|default:product.price }}"
                 data-image="{{ variant.image.url|default:product.image.url }}"
                 data-stock="{{ variant.stock }}"
                 title="{{ variant.color.name }}">
            {% endfor %}
        </div>
        {% endif %}
    </div>

    <div class="col-md-6">
        <h1 class="mb-3 golden-text-heading">{{ product.name }}</h1>
        <p class="lead dark-golden-text fs-3 mb-2" id="productPrice"><small>ETB</small> {{ product.price }}</p>
        <div class="mb-4">
            <div class="d-flex justify-content-between align-items-center">
                <h5 class="mb-0 golden-text-heading">Availability</h5>
                <div id="stockInfo" class="text-end">
                    {% if variants %}
                        {% with total=product.stock %}
                            {% for variant in variants %}
                                {% with total=total|add:variant.stock %}
                                    {% if forloop.last %}
                                        <div class="d-flex align-items-center justify-content-end">
                                            <i class="bi bi-box-seam me-1"></i>
                                            <span class="fw-bold">
                                                <span id="variantStock" class="d-none">0</span>
                                                <span id="totalStock">{{ total|default:0 }}</span> in stock
                                                <small id="selectedVariantStock" class="text-muted d-none ms-2">
                                                    (<span id="variantStockValue">0</span> in selected color)
                                                </small>
                                            </span>
                                        </div>
                                    {% endif %}
                                {% endwith %}
                            {% endfor %}
                        {% endwith %}
                    {% else %}
                        <div class="d-flex align-items-center justify-content-end">
                            <i class="bi bi-box-seam me-1"></i>
                            <span class="fw-bold">{{ product.stock|default:0 }} in stock</span>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
        <p class="text-secondary">{{ product.description }}</p>

        {% if variants %}
        <h4 class="mt-4 mb-3 golden-text-heading">Color Options</h4>
        <select id="variantSelect" class="form-select mb-3">
            <option value="">Select Color</option>
            {% for variant in variants %}
            <option value="{{ variant.id }}" 
                    data-price="{{ variant.price|default:product.price }}" 
                    data-image="{{ variant.image.url|default:product.image.url }}" 
                    data-stock="{{ variant.stock }}">
                {{ variant.color.name }} ({{ variant.stock }} remaining)
            </option>
            {% empty %}
            <option disabled>No colors available</option>
            {% endfor %}
        </select>
        {% endif %}

        <form method="post" action="{% url 'add_to_cart' product.pk %}" id="addForm">
            {% csrf_token %}
            <input type="hidden" name="variant_id" id="variantIdInput" value="">
            
            <div class="input-group mb-3">
                <span class="input-group-text">Quantity</span>
                <input type="number" name="quantity" value="1" min="1" max="{{ product.stock }}" class="form-control" id="quantityInput">
                <button type="submit" class="btn btn-golden-success" id="addCartBtn">Add to Cart</button>
            </div>
        </form>
        <a href="{% url 'products' %}" class="btn btn-outline-secondary">Back to Products</a>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script>
$(document).ready(function() {
    // Initial check for the main product's stock
    if ({{ product.stock }} == 0) {
        $('#addCartBtn').prop('disabled', true);
    }
    
    // Function to update all UI elements based on selected variant/thumbnail data
    function updateProductUI(data) {
        console.log('Updating UI with data:', data);
        
        // Update main image with fade effect
        if (data.image) {
            const $img = $('#productImage');
            $img.css('opacity', '0.6');
            setTimeout(() => {
                $img.attr('src', data.image);
                $img.css('opacity', '1');
            }, 150);
        }
        
        // Update price
        if (data.price) {
            $('#productPrice').text('ETB ' + parseFloat(data.price).toFixed(2));
        }
        
        // Update stock information
        if (data.variantId) {
            // If it's a variant, show both total and variant stock
            const variantStock = parseInt(data.stock) || 0;
            const totalStock = parseInt($('#totalStock').text()) || 0;
            
            // Update the display
            $('#variantStockValue').text(variantStock);
            
            // Show/hide variant stock information
            if (variantStock > 0) {
                $('#selectedVariantStock').removeClass('d-none text-danger').addClass('d-inline');
                
                // Update colors based on stock level
                const stockElement = $('#stockInfo .fw-bold');
                stockElement.removeClass('text-warning text-danger').addClass('text-success');
                
                if (variantStock <= 10) {
                    stockElement.removeClass('text-success').addClass('text-warning');
                    if (variantStock <= 3) {
                        stockElement.removeClass('text-warning').addClass('text-danger');
                    }
                }
            } else {
                $('#selectedVariantStock').removeClass('d-none').addClass('d-inline text-danger');
                $('#stockInfo .fw-bold').removeClass('text-success text-warning').addClass('text-danger');
            }
        } else {
            // For main product without variants
            const stock = parseInt(data.stock) || 0;
            const stockElement = $('#stockInfo .fw-bold');
            
            // Update colors based on stock level
            stockElement.removeClass('text-warning text-danger').addClass('text-success');
            
            if (stock <= 10) {
                stockElement.removeClass('text-success').addClass('text-warning');
                if (stock === 0) {
                    stockElement.removeClass('text-warning').addClass('text-danger');
                }
            }
        }
        
        // Update quantity and button state
        $('#quantityInput').attr('max', data.stock).val(Math.min(1, data.stock));
        $('#addCartBtn').prop('disabled', data.stock === 0);
        
        // Update the form action for the correct product/variant
        if (data.id) {
            // Set the hidden input for the variant ID
            $('#variantIdInput').val(data.id);
            // If the URL needs to change for the variant, update the form action
            // $('#addForm').attr('action', "{% url 'add_to_cart' product.pk %}?variant=" + data.id); 
        } else {
             $('#variantIdInput').val('');
        }
    }

    // Initialize the page with the main product data
    $(document).ready(function() {
        console.log('Initializing product page...');
        
        // Get the main product data from the template
        const initialData = {
            price: '{{ product.price }}',
            image: '{{ product.image.url|default:"" }}',
            stock: {{ product.stock|default:0 }}
        };
        
        console.log('Initial product data:', initialData);
        
        // Initialize the UI with the main product data
        updateProductUI(initialData);
        
        // If there are variants, select the first one by default
        if ($('.img-thumbnail-variant').length > 0) {
            const firstVariant = $('.img-thumbnail-variant').first();
            if (firstVariant.length) {
                firstVariant.trigger('click');
            }
        }
        
        // Set up variant selection with smooth scrolling
        $('.img-thumbnail-variant').on('click', function() {
            const $this = $(this);
            
            // Update active state with animation
            $('.img-thumbnail-variant').removeClass('active');
            $this.addClass('active');
            
            // Scroll to make the selected variant visible
            const container = $this.parent();
            const containerWidth = container.width();
            const scrollLeft = $this.position().left + container.scrollLeft() - (containerWidth / 2) + ($this.width() / 2);
            
            container.animate({
                scrollLeft: scrollLeft
            }, 300);
            
            const variantData = {
                variantId: $this.data('id'),
                id: $this.data('id'),
                price: $this.data('price'),
                image: $this.data('image'),
                stock: $this.data('stock')
            };
            
            console.log('Variant selected:', variantData);
            updateProductUI(variantData);
            $('#variantSelect').val(variantData.id || '');
        });
        
        // Set up dropdown change handler
        $('#variantSelect').change(function() {
            const selectedId = $(this).val();
            if (selectedId) {
                const variant = $('.img-thumbnail-variant[data-id="' + selectedId + '"]');
                if (variant.length) {
                    variant.trigger('click');
                }
            } else {
                // Reset to main product
                updateProductUI(initialData);
                $('.img-thumbnail-variant').removeClass('active border-2 border-warning');
                $('.img-thumbnail-variant[data-id=""]').addClass('active border-2 border-warning');
                $('#selectedVariantStock').addClass('d-none');
                $('#stockInfo .fw-bold').removeClass('text-warning text-danger').addClass('text-success');
            }
        });
        
        // Log the final state
        setTimeout(function() {
            console.log('Stock element:', document.getElementById('stockCount')?.outerHTML);
            console.log('Message element:', document.getElementById('stockMessage')?.outerHTML);
        }, 200);
    });
    
    // --- Event Handlers ---
    
    // 1. Thumbnail Click Handler
    $('.img-thumbnail-variant').on('click', function() {
        // Remove active state from all thumbnails and apply to clicked one
        $('.img-thumbnail-variant').removeClass('active');
        $(this).addClass('active');

        // Get data from the thumbnail
        const data = {
            id: $(this).data('id'),
            price: $(this).data('price'),
            image: $(this).data('image'),
            stock: $(this).data('stock')
        };
        
        updateProductUI(data);

        // Synchronize the dropdown
        $('#variantSelect').val(data.id || '');
    });

    // 2. Dropdown Change Handler
    $('#variantSelect').change(function() {
        const selected = $(this).val();
        let data = {};
        
        if (selected) {
            const option = $(this).find('option:selected');
            data = {
                id: option.val(),
                price: option.data('price'),
                image: option.data('image'),
                stock: option.data('stock')
            };
            
            // Synchronize thumbnails
            $('.img-thumbnail-variant').removeClass('active');
            $(`.img-thumbnail-variant[data-id="${selected}"]`).addClass('active');

        } else {
            // Reset to default product data
            data = {
                id: null,
                price: '{{ product.price }}',
                image: '{{ product.image.url|default:"https://via.placeholder.com/400x300?text=No+Image" }}',
                stock: '{{ product.stock }}'
            };
            
            // Synchronize thumbnails (activate the main one)
            $('.img-thumbnail-variant').removeClass('active');
            $(`.img-thumbnail-variant[data-id="{{ product.pk }}"]`).addClass('active');
        }
        
        updateProductUI(data);
    });
});
</script>
{% endblock %}